# معالجة الفشل في نظام قائمة المهام

هذا الملف يشرح آليات معالجة المهام الفاشلة في نظام قائمة المهام.

## نظرة عامة

يتضمن النظام آليات متعددة للتعامل مع المهام الفاشلة:

1. **إعادة المحاولة التلقائية**: يحاول النظام تلقائيًا إعادة تنفيذ المهام الفاشلة عدة مرات.
2. **قائمة انتظار الرسائل الميتة (Dead Letter Queue)**: يتم نقل المهام التي تفشل بشكل دائم إلى قائمة انتظار خاصة.
3. **نظام الإشعارات**: يرسل النظام إشعارات عند فشل المهام بشكل دائم.
4. **واجهة إدارة المهام الفاشلة**: يوفر النظام واجهة لعرض وإدارة المهام الفاشلة.

## آلية إعادة المحاولة

عندما تفشل مهمة، يقوم النظام تلقائيًا بإعادة محاولة تنفيذها عدة مرات:

1. **عدد المحاولات**: يتم تحديد عدد المحاولات في حقل `max_retries` في نموذج المهمة.
2. **تأخير تصاعدي**: يتم زيادة التأخير بين المحاولات بشكل تصاعدي (exponential backoff).
3. **تتبع المحاولات**: يتم تتبع عدد المحاولات في حقل `retry_count` في نموذج المهمة.

## قائمة انتظار الرسائل الميتة (Dead Letter Queue)

بعد استنفاد جميع محاولات إعادة التنفيذ، يتم نقل المهمة إلى قائمة انتظار الرسائل الميتة:

1. **تسجيل المهمة الفاشلة**: يتم إنشاء سجل في نموذج `DeadLetterQueue` يحتوي على معلومات المهمة الفاشلة.
2. **تخزين معلومات الخطأ**: يتم تخزين رسالة الخطأ وتتبع الاستدعاء للخطأ.
3. **الربط بالمهمة الأصلية**: يتم ربط سجل قائمة انتظار الرسائل الميتة بالمهمة الأصلية.

## نظام الإشعارات

عند فشل مهمة بشكل دائم، يقوم النظام بإرسال إشعارات:

1. **إشعارات البريد الإلكتروني**: يتم إرسال بريد إلكتروني إلى المسؤولين المحددين في إعدادات `ADMIN_EMAILS`.
2. **سجلات النظام**: يتم تسجيل رسائل خطأ حرجة في سجلات النظام.

## واجهة إدارة المهام الفاشلة

يوفر النظام واجهة إدارة للمهام الفاشلة في لوحة تحكم Django:

1. **عرض المهام الفاشلة**: يمكن عرض جميع المهام الفاشلة وتفاصيلها.
2. **إعادة معالجة المهام**: يمكن إعادة معالجة المهام الفاشلة من خلال واجهة الإدارة.
3. **إرسال إشعارات يدويًا**: يمكن إرسال إشعارات يدويًا للمهام الفاشلة.

## كيفية استخدام النظام

### 1. عرض المهام الفاشلة

يمكن عرض المهام الفاشلة من خلال:

1. **واجهة إدارة Django**: انتقل إلى `/admin/jobs/deadletterqueue/` لعرض المهام الفاشلة.
2. **تصفية المهام**: يمكن تصفية المهام حسب حالة إعادة المعالجة أو حالة الإشعار.

### 2. إعادة معالجة المهام الفاشلة

يمكن إعادة معالجة المهام الفاشلة من خلال:

1. **واجهة إدارة Django**: حدد المهام التي تريد إعادة معالجتها واختر "إعادة معالجة المهام المحددة" من قائمة الإجراءات.
2. **برمجيًا**: استخدم مهمة `reprocess_failed_task` مع معرف سجل قائمة انتظار الرسائل الميتة.

### 3. إرسال إشعارات للمهام الفاشلة

يمكن إرسال إشعارات للمهام الفاشلة من خلال:

1. **واجهة إدارة Django**: حدد المهام التي تريد إرسال إشعارات لها واختر "إرسال إشعارات للمهام المحددة" من قائمة الإجراءات.
2. **برمجيًا**: استخدم مهمة `send_failure_notification` مع معرف سجل قائمة انتظار الرسائل الميتة.

## تكوين النظام

يمكن تكوين نظام معالجة الفشل من خلال:

### 1. إعدادات البريد الإلكتروني

في ملف `settings.py`:

```python
# Email settings for failure notifications
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'  # Use SMTP for production
EMAIL_HOST = 'smtp.example.com'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = 'your-email@example.com'
EMAIL_HOST_PASSWORD = 'your-password'
DEFAULT_FROM_EMAIL = 'noreply@example.com'
ADMIN_EMAILS = ['admin@example.com']  # Add your email here to receive failure notifications
```

### 2. إعدادات إعادة المحاولة

في نموذج المهمة:

```python
@shared_task(bind=True, base=JobTask, 
             autoretry_for=(Exception,), 
             retry_backoff=True, 
             retry_backoff_max=600, 
             retry_jitter=True)
def process_job_task(self, job_id):
    # ...
```

## اختبار النظام

يمكن اختبار نظام معالجة الفشل من خلال:

1. **إنشاء مهمة تفشل عمدًا**:

```python
@shared_task(bind=True, base=JobTask)
def test_failure_task(self, job_id):
    raise ValueError("This is a test failure")
```

2. **مراقبة سجلات النظام**: راقب سجلات النظام لمعرفة كيف يتم التعامل مع المهمة الفاشلة.

3. **التحقق من قائمة انتظار الرسائل الميتة**: تحقق من وجود سجل للمهمة الفاشلة في قائمة انتظار الرسائل الميتة.

4. **التحقق من الإشعارات**: تحقق من إرسال الإشعارات للمهمة الفاشلة.
