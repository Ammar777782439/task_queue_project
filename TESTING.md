# اختبار نظام قائمة المهام

هذا الملف يشرح كيفية اختبار ميزات نظام قائمة المهام، بما في ذلك الأولوية والتزامن ومعالجة الفشل.

## اختبار الأولوية والتزامن

### الطريقة السهلة (باستخدام الملف النصي)

1. **تشغيل ملف الاختبار التلقائي**:
   ```
   run_priority_concurrency_test.bat
   ```
   
   هذا الملف سيقوم بـ:
   - التأكد من تشغيل Redis
   - التأكد من تشغيل Celery Worker
   - مسح المهام القديمة وإنشاء مهام اختبار جديدة
   - عرض حالة المهام كل 5 ثوانٍ

### الطريقة اليدوية (خطوة بخطوة)

1. **تشغيل Redis**:
   ```
   docker-compose up -d redis
   ```

2. **تشغيل Celery Worker**:
   ```
   celery -A task_queue_project worker --loglevel=info -P gevent --concurrency=4 --prefetch-multiplier=1
   ```

3. **إنشاء مهام اختبار**:
   ```
   python manage.py test_priority_concurrency --count=12 --sleep=15 --clear
   ```
   
   الخيارات:
   - `--count`: عدد المهام المراد إنشاؤها
   - `--sleep`: وقت النوم لكل مهمة بالثواني
   - `--clear`: مسح المهام القديمة قبل إنشاء مهام جديدة

4. **مراقبة حالة المهام**:
   ```
   python manage.py shell -c "from jobs.models import Job; print('\n'.join([f'المهمة: {j.task_name}, الحالة: {j.status}, الأولوية: {j.priority}' for j in Job.objects.all().order_by('-priority')]))"
   ```

## اختبار معالجة الفشل

### الطريقة السهلة

1. **إنشاء مهمة اختبار تفشل**:
   ```
   python manage.py test_failure_handling
   ```
   
   هذا الأمر سينشئ مهمة اختبار تفشل، وسيتم إرسالها إلى قائمة انتظار الرسائل الميتة بعد استنفاد محاولات إعادة التنفيذ.

2. **عرض المهام الفاشلة**:
   انتقل إلى `/admin/jobs/deadletterqueue/` في واجهة إدارة Django لعرض المهام الفاشلة.

## ما الذي يجب أن تراه

### اختبار الأولوية

1. **ترتيب التنفيذ حسب الأولوية**:
   - المهام ذات الأولوية 10 (عالية) يجب أن تبدأ أولاً
   - المهام ذات الأولوية 5 (متوسطة) يجب أن تبدأ بعد ذلك
   - المهام ذات الأولوية 0 (منخفضة) يجب أن تبدأ أخيراً

### اختبار التزامن

1. **عدد المهام المتزامنة**:
   - يجب أن ترى 4 مهام في حالة "In Progress" في نفس الوقت (بناءً على إعدادات التزامن)
   - عندما تكتمل مهمة، يجب أن تبدأ مهمة جديدة

### اختبار معالجة الفشل

1. **إعادة المحاولة**:
   - يجب أن ترى المهمة تفشل وتتم إعادة محاولتها عدة مرات
   - يجب أن ترى زيادة في عداد إعادة المحاولة في نموذج المهمة

2. **قائمة انتظار الرسائل الميتة**:
   - بعد استنفاد جميع محاولات إعادة التنفيذ، يجب أن ترى سجلاً جديداً في قائمة انتظار الرسائل الميتة
   - يجب أن يحتوي السجل على معلومات المهمة الفاشلة ورسالة الخطأ

3. **الإشعارات**:
   - يجب أن ترى إشعاراً في سجلات النظام
   - إذا كانت إعدادات البريد الإلكتروني مكونة بشكل صحيح، يجب أن تتلقى بريداً إلكترونياً

## استكشاف الأخطاء وإصلاحها

### مشاكل الأولوية

1. **المهام لا تنفذ حسب الأولوية**:
   - تأكد من أن Celery Worker يعمل بالإعدادات الصحيحة
   - تأكد من أن المهام تُنشأ بأولويات مختلفة
   - تحقق من سجلات Celery Worker للتأكد من استلام المهام بالترتيب الصحيح

### مشاكل التزامن

1. **عدد المهام المتزامنة غير صحيح**:
   - تأكد من تشغيل Celery Worker بالخيار `--concurrency=4`
   - تأكد من تعيين `CELERY_WORKER_CONCURRENCY = 4` في ملف settings.py
   - تحقق من استخدام `-P gevent` لدعم التزامن الحقيقي

### مشاكل معالجة الفشل

1. **المهام الفاشلة لا تظهر في قائمة انتظار الرسائل الميتة**:
   - تأكد من تفعيل دالة `on_failure` في فئة `JobTask`
   - تأكد من تشغيل الهجرة لإنشاء جدول `DeadLetterQueue`
   - تحقق من سجلات Celery Worker للتأكد من استدعاء `send_to_dead_letter_queue`

2. **الإشعارات لا تُرسل**:
   - تأكد من تكوين إعدادات البريد الإلكتروني في ملف settings.py
   - تحقق من سجلات النظام للتأكد من استدعاء `send_failure_notification`
