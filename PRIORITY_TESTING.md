# اختبار نظام الأولوية في مشروع قائمة المهام

هذا الملف يشرح كيفية اختبار نظام الأولوية بعد التعديلات التي تم إجراؤها.

## نظرة عامة على النهج الجديد

بدلاً من استخدام القوائم المتعددة أو خاصية الأولوية المدمجة في Redis/Celery، قمنا بتنفيذ نهج التأخير العكسي:

1. نستخدم قائمة واحدة فقط لجميع المهام
2. نقوم بتطبيق تأخير عكسي بناءً على الأولوية
3. المهام ذات الأولوية الأعلى لها تأخير أقل
4. المهام ذات الأولوية الأقل لها تأخير أكبر

هذا النهج أكثر موثوقية ويعمل بشكل متسق عبر جميع إصدارات Redis وCelery لأنه لا يعتمد على ميزات خاصة بالوسيط.

### كيفية حساب التأخير

يتم حساب التأخير باستخدام الصيغة التالية:

```
countdown = max(0, 10 - priority)
```

هذا يعني:
- المهام ذات الأولوية 10 لها تأخير 0 ثانية (تنفذ فوراً)
- المهام ذات الأولوية 9 لها تأخير 1 ثانية
- المهام ذات الأولوية 0 لها تأخير 10 ثواني

## الخطوات المطلوبة

### الطريقة السهلة (باستخدام ملف الاختبار التلقائي):

1. **قم بتشغيل Celery Worker أولاً**:
   ```
   restart_worker.bat
   ```

2. **في نافذة طرفية جديدة، قم بتشغيل اختبار الأولوية**:
   ```
   priority_test.bat
   ```

### الطريقة اليدوية (خطوة بخطوة):

1. **إعادة تشغيل Redis**:
   ```
   docker-compose restart redis
   ```

2. **تثبيت المتطلبات المحدثة**:
   ```
   pip install -r requirements.txt
   ```

3. **إعادة تشغيل Celery Worker**:
   ```
   celery -A task_queue_project worker --loglevel=info -P solo --without-heartbeat --without-gossip --without-mingle --concurrency=1
   ```

4. **مسح المهام القديمة**:
   ```
   python manage.py shell -c "from jobs.models import Job; Job.objects.all().delete()"
   ```

5. **اختبار نظام الأولوية**:
   ```
   python manage.py test_priority
   ```

   هذا الأمر سيقوم بإنشاء 6 مهام بأولويات مختلفة (1, 5, 10, 3, 8, 2) وإضافتها إلى قائمة الانتظار.

   يجب أن ترى المهام يتم تنفيذها بترتيب الأولوية التنازلي (من الأعلى إلى الأدنى):
   - Priority Test 3 (Priority: 10) - أولاً
   - Priority Test 5 (Priority: 8) - ثانياً
   - Priority Test 2 (Priority: 5) - ثالثاً
   - Priority Test 4 (Priority: 3) - رابعاً
   - Priority Test 6 (Priority: 2) - خامساً
   - Priority Test 1 (Priority: 1) - أخيراً

## ملاحظات مهمة

1. **إعادة تشغيل Redis ضرورية**: يجب إعادة تشغيل Redis بعد تغيير إعدادات الأولوية لضمان تطبيق الإعدادات الجديدة.

2. **خيارات Celery Worker**: الخيارات `--without-heartbeat --without-gossip --without-mingle` تساعد في تقليل الضوضاء في السجلات وتحسين أداء العامل.

3. **مراقبة السجلات**: راقب سجلات Celery Worker بعناية لمعرفة ترتيب تنفيذ المهام.

4. **التحقق من حالة المهام**: يمكنك التحقق من حالة المهام في واجهة الإدارة على `http://127.0.0.1:8000/admin/jobs/job/`.

## استكشاف الأخطاء وإصلاحها

إذا لم تعمل الأولويات كما هو متوقع، تحقق من:

1. **إصدار Redis**: تأكد من أن إصدار Redis يدعم الأولويات (الإصدار 5.0 أو أعلى).

2. **إعدادات Celery**: تأكد من تطبيق جميع إعدادات Celery المتعلقة بالأولوية.

3. **إعادة تشغيل كاملة**: قم بإيقاف وإعادة تشغيل Redis وCelery Worker والتطبيق.

4. **تنظيف قاعدة البيانات**: قم بمسح المهام القديمة وإنشاء مهام جديدة للاختبار.
