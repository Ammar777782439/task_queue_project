# اختبار نظام الأولوية في مشروع قائمة المهام

هذا الملف يشرح كيفية اختبار نظام الأولوية بعد التعديلات التي تم إجراؤها.

## نظرة عامة على النهج الجديد

بدلاً من استخدام خاصية الأولوية المدمجة في Redis/Celery والتي قد لا تعمل بشكل موثوق في بعض البيئات، قمنا بتنفيذ نهج القوائم المتعددة:

1. أنشأنا قائمة منفصلة لكل مستوى أولوية (0-10)
2. يتم توجيه المهام إلى القائمة المناسبة بناءً على قيمة الأولوية الخاصة بها
3. يقوم Celery Worker باستهلاك المهام من القوائم بترتيب الأولوية (من الأعلى إلى الأدنى)

هذا النهج أكثر موثوقية ويعمل بشكل متسق عبر جميع إصدارات Redis وCelery.

## الخطوات المطلوبة

1. **إعادة تشغيل Redis**:
   ```
   docker-compose restart redis
   ```

2. **تثبيت المتطلبات المحدثة**:
   ```
   pip install -r requirements.txt
   ```

3. **إعادة تشغيل Celery Worker مع دعم الأولوية**:
   ```
   celery -A task_queue_project worker --loglevel=info -P solo -Q priority_10,priority_9,priority_8,priority_7,priority_6,priority_5,priority_4,priority_3,priority_2,priority_1,priority_0 --without-heartbeat --without-gossip --without-mingle
   ```

   أو استخدم الملف النصي المرفق:
   ```
   restart_worker.bat
   ```

4. **اختبار نظام الأولوية**:

   قم بتشغيل أمر الاختبار الخاص:
   ```
   python manage.py test_priority
   ```

   هذا الأمر سيقوم بإنشاء 6 مهام بأولويات مختلفة (1, 5, 10, 3, 8, 2) وإضافتها إلى قائمة الانتظار.

   يجب أن ترى المهام يتم تنفيذها بترتيب الأولوية التنازلي (من الأعلى إلى الأدنى):
   - Priority Test 3 (Priority: 10) - أولاً
   - Priority Test 5 (Priority: 8) - ثانياً
   - Priority Test 2 (Priority: 5) - ثالثاً
   - Priority Test 4 (Priority: 3) - رابعاً
   - Priority Test 6 (Priority: 2) - خامساً
   - Priority Test 1 (Priority: 1) - أخيراً

## ملاحظات مهمة

1. **إعادة تشغيل Redis ضرورية**: يجب إعادة تشغيل Redis بعد تغيير إعدادات الأولوية لضمان تطبيق الإعدادات الجديدة.

2. **خيارات Celery Worker**: الخيارات `--without-heartbeat --without-gossip --without-mingle` تساعد في تقليل الضوضاء في السجلات وتحسين أداء العامل.

3. **مراقبة السجلات**: راقب سجلات Celery Worker بعناية لمعرفة ترتيب تنفيذ المهام.

4. **التحقق من حالة المهام**: يمكنك التحقق من حالة المهام في واجهة الإدارة على `http://127.0.0.1:8000/admin/jobs/job/`.

## استكشاف الأخطاء وإصلاحها

إذا لم تعمل الأولويات كما هو متوقع، تحقق من:

1. **إصدار Redis**: تأكد من أن إصدار Redis يدعم الأولويات (الإصدار 5.0 أو أعلى).

2. **إعدادات Celery**: تأكد من تطبيق جميع إعدادات Celery المتعلقة بالأولوية.

3. **إعادة تشغيل كاملة**: قم بإيقاف وإعادة تشغيل Redis وCelery Worker والتطبيق.

4. **تنظيف قاعدة البيانات**: قم بمسح المهام القديمة وإنشاء مهام جديدة للاختبار.
