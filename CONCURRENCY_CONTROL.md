# التحكم في التزامن (Concurrency Control)

هذا الملف يشرح كيفية التحكم في عدد المهام التي يتم تنفيذها بشكل متزامن في مشروع قائمة المهام.

## نظرة عامة

التحكم في التزامن يسمح لك بتحديد عدد المهام التي يمكن معالجتها في وقت واحد. هذا مفيد لعدة أسباب:

1. **تحسين الأداء**: منع تحميل النظام بعدد كبير من المهام المتزامنة
2. **إدارة الموارد**: التحكم في استهلاك موارد النظام (CPU، الذاكرة، اتصالات قاعدة البيانات)
3. **تجنب الاختناقات**: منع حدوث اختناقات في الخدمات الخارجية أو قاعدة البيانات

## الإعدادات الحالية

حاليًا، تم تكوين النظام للسماح بـ:

- **4 عمليات عامل متزامنة**: يمكن لـ Celery تشغيل 4 عمليات عامل في وقت واحد
- **4 مهام لكل عامل**: يمكن لكل عامل سحب 4 مهام في وقت واحد

هذا يعني أن النظام يمكنه معالجة ما يصل إلى 16 مهمة في وقت واحد (4 عمال × 4 مهام لكل عامل).

## كيفية تعديل إعدادات التزامن

### 1. تعديل عدد العمال المتزامنين

يمكنك تعديل عدد العمال المتزامنين من خلال تغيير الإعداد `CELERY_WORKER_CONCURRENCY` في ملف `settings.py`:

```python
# Concurrency control settings
CELERY_WORKER_CONCURRENCY = 4  # Allow 4 concurrent worker processes
```

### 2. تعديل عدد المهام لكل عامل

يمكنك تعديل عدد المهام التي يمكن لكل عامل سحبها في وقت واحد من خلال تغيير الإعداد `CELERY_WORKER_PREFETCH_MULTIPLIER` في ملف `settings.py`:

```python
# Concurrency control settings
CELERY_WORKER_PREFETCH_MULTIPLIER = 4  # Allow each worker to prefetch 4 tasks
```

### 3. تعديل إعدادات التزامن عند تشغيل العامل

يمكنك أيضًا تعديل إعدادات التزامن عند تشغيل العامل من خلال استخدام الخيار `--concurrency`:

```bash
celery -A task_queue_project worker --loglevel=info --concurrency=4
```

## ملاحظات هامة

1. **زيادة التزامن**: زيادة عدد العمال المتزامنين يمكن أن يحسن الأداء، ولكن قد يؤدي أيضًا إلى زيادة استهلام الموارد.

2. **تقليل التزامن**: تقليل عدد العمال المتزامنين يمكن أن يقلل من استهلاك الموارد، ولكن قد يؤدي إلى تأخير في معالجة المهام.

3. **التوازن**: يجب عليك إيجاد التوازن المناسب بين عدد العمال المتزامنين وعدد المهام لكل عامل بناءً على موارد النظام واحتياجات التطبيق.

## اختبار إعدادات التزامن

يمكنك اختبار إعدادات التزامن من خلال إنشاء عدة مهام وملاحظة كيف يتم تنفيذها:

1. **إعادة تشغيل العامل**:
   ```
   restart_worker.bat
   ```

2. **إنشاء عدة مهام**:
   ```
   python manage.py create_test_jobs 10 --max_priority 10
   ```

3. **مراقبة تنفيذ المهام**:
   - راقب سجلات العامل لمعرفة كيف يتم تنفيذ المهام
   - تحقق من حالة المهام في واجهة الإدارة
